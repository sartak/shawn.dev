#!/usr/bin/perl
use strict;
use warnings;
use Mana::Docker;

my $tempDir = "/tmp/blog-frontend-$$";
mkdir($tempDir);
mkdir("$tempDir/new");

getopt({
  destination => {
    flag    => 'destination=s',
    dir     => 1,
    default => sub {
      if ($ARGV{is_devel}) {
        return '/var/www/blog.dev.shawn.zone';
      } else {
        return '/var/www/blog.shawn.zone';
      }
    },
  },
}, {
  image => 'blog-frontend',
  rm => 1,
});

actions(
  'build',
  run => [
    mount(
      '.' => '/app',
      "$tempDir/new" => '/out',
    ),
    env(
      OUTDIR => "/out",
      BASE_URL => 'https://shawn.dev',
      SITE_NAME => 'shawn.dev',
      SITE_TITLE => 'shawn.dev',
      FEED_TITLE => 'Shawn M Moore',
    ),
    cmd('./bin/generate.pl'),
  ],
  exec => ['sudo', 'mv', $ARGV{destination}, "$tempDir/old"],
  exec => ['sudo', 'mv', "$tempDir/new", $ARGV{destination}],
  exec => ['sudo', 'rm', '-r', $tempDir],
);
